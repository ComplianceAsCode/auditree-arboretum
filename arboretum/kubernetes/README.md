# Kubernetes library

The fetchers and checks contained within this `kubernetes` category folder are
common tests that can be configured and executed for the purpose of generating
compliance reports and notifications using the [auditree-framework][].
See [auditree-framework documentation][] for more details.

These tests are normally executed by a CI/CD system like
[Travis CI](https://travis-ci.com/) as part of another project that uses this
library package as a dependency.

## Usage as a library

See [usage][] for specifics on including this library as a dependency and how
to include the fetchers and checks from this library in your downstream project.

## Fetchers

### Cluster Resource

* Class: [ClusterResourceFetcher][fetch-cluster-resource]
* Purpose: Write the resources of **stand-alone** Kubernetes clusters to the
evidence locker.  **NOTE:** Do not use this fetcher for managed clusters.
For IBM Cloud clusters, use the
[IBM Cloud cluster list fetcher][ibm-cloud-cluster-list-fetcher] and the
[IBM Cloud cluster resource fetcher][ibm-cloud-cluster-resource-fetcher].
* Behavior: Retrieve stand-alone Kubernetes cluster resource data for the provided
list of clusters.  TTL is set to 1 day.
* Configuration elements:
  * `org.kubernetes.cluster_resources.clusters`
    * Required
    * List of dictionaries:
      * `label`: An arbitrary label to specify token in credentials file
      * `server` A URL as a string to a Kubernetes stand-alone cluster
  * `org.kubernetes.cluster_resources.types`
    * Optional
    * List of resource types as strings
      * NOTE: For core group API resources, the resource name must be in
      _plural form_ (e.g., `secrets`).
      * NOTE: For other named group resources including custom API
        resources, the resource name must be in the following format:
        `APIGROUP/VERSION/NAME`. You can compose this by first executing
        `kubectl api-resources` and `kubectl api-versions` and then combining
        the results into your resource name.  Using `cronjobs` as an example:

        ```sh
        $ kubectl api-resources -o name | fgrep cronjobs
        cronjobs.batch
        $ kubectl api-versions | grep batch
        batch/v1
        batch/v1beta1
        ```

        For this example `batch/v1` is the more stable version so we use that
        to compose `APIGROUP/VERSION/NAME` resource name as `batch/v1/cronjobs`.
    * Use if looking to override the default of `["nodes", "pods", "configmaps"]`.
    Otherwise do not include.
* Expected configuration:

  ```json
  {
    "org": {
      "kubernetes": {
        "cluster_resources": {
          "clusters": [
            {
              "label": "devcluster1",
              "server": "https://myserver1:30000"
            }
          ],
          "types": ["secrets", "batch/v1/cronjobs", "apigroup.example.com/v1/mycustom"]
        }
      }
    }
  }
   ```

* Required credentials:
  * A token of a Kubernetes service account is required.
    * `<cluster label>_token`: a token string for the cluster label value from
      your configuration. Using the expected configuration from above as an
      example, a token named `devcluster1_token` would be the expected credential.
    * Example credential file entry:

      ```ini
      [kubernetes]
      devcluster1_token=my-devcluster1-token
      ```

    * The token can be generated by following these steps.
      1. Create a service account (you can omit this step if you want to use
         an existing service account).

         ```sh
         kubectl create serviceaccount my-new-service-account
         ```

      2. Assign `get` permission for the resource types specified in
         `org.kubernetes.cluster_resources.types` to the service account by
         creating `clusterrole` and `clusterrolerolebinding`.  For details,
         see the [Kubernetes RBAC documentation][kube-rbac-docs].
      3. Get a token stored in a secret resource bound with the service
         account. The command below returns the token string.

         ```sh
         kubectl get serviceaccount my-new-service-account -ojsonpath='{.secrets[0].name}' | xargs kubectl get secret -ojsonpath='{.data.token}'
         ```

* Import statement:

   ```python
   from arboretum.kubernetes.fetchers.fetch_cluster_resource import ClusterResourceFetcher
   ```

## Checks

Checks coming soon...

[auditree-framework]: https://github.com/ComplianceAsCode/auditree-framework
[auditree-framework documentation]: https://complianceascode.github.io/auditree-framework/
[usage]: https://github.com/ComplianceAsCode/auditree-arboretum#usage
[fetch-cluster-resource]: https://github.com/ComplianceAsCode/auditree-arboretum/blob/main/arboretum/kubernetes/fetchers/fetch_cluster_resource.py
[ibm-cloud-cluster-list-fetcher]: https://github.com/ComplianceAsCode/auditree-arboretum/tree/main/arboretum/ibm_cloud#cluster-list
[ibm-cloud-cluster-resource-fetcher]: https://github.com/ComplianceAsCode/auditree-arboretum/tree/main/arboretum/ibm_cloud#cluster-resource
[kube-rbac-docs]: https://kubernetes.io/docs/reference/access-authn-authz/rbac/
